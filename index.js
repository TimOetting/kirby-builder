(function () {function d(t){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function f(t,e){return i(t)||h(t,e)||g()}function g(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function h(t,e){var n=[],o=!0,i=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(o=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);o=!0);}catch(l){i=!0,r=l}finally{try{o||null==a.return||a.return()}finally{if(i)throw r}}return n}function i(t){if(Array.isArray(t))return t}var a={data:function(){return{previewFrameWindow:{},previewFrameDocument:{},previewHeight:0}},props:{markup:{type:String},styles:{type:String},script:{type:String},cssContent:{type:String},index:{type:Number}},computed:{heighto:function(){return this.previewFrameDocument.getElementById("content").scrollHeight}},mounted:function(){this.$root.$on("blockMoved",this.updateFrameIfEmpty),this.previewFrameWindow=this.$refs.previewFrame.contentWindow,this.previewFrameDocument=this.previewFrameWindow.document,this.updateContent();var e=document.createElement("script");if(e.type="text/javascript",e.innerHTML="\n      sendResizeEvent = function () {\n        if (window.frameElement) {\n          window.frameElement.dispatchEvent(new CustomEvent('sizechange', { detail: { height: document.documentElement.offsetHeight } }))\n        }\n      }\n      sendResizedEvent = function () {\n        console.log('on resize')\n      }\n    ",this.previewFrameDocument.getElementsByTagName("body")[0].appendChild(e),this.updateContent(),this.script){var t=document.createElement("script");t.type="text/javascript",t.innerHTML=this.script,this.previewFrameDocument.getElementsByTagName("body")[0].appendChild(t)}},methods:{updateContent:function(){var e=this;this.$nextTick().then(function(){e.previewFrameWindow=e.$refs.previewFrame.contentWindow,e.previewFrameDocument=e.previewFrameWindow.document,e.previewFrameDocument.open(),e.previewFrameDocument.write(e.$refs.previewFrameContent.innerHTML),e.previewFrameDocument.close(),e.resize()})},updateFrameIfEmpty:function(){var e=this;this.$nextTick().then(function(){null===e.$refs.previewFrame.contentWindow.document.getElementById("content")&&e.updateContent()})},onResize:function(e){this.resize()},resize:function(){this.previewHeight=this.previewFrameDocument.getElementById("content").scrollHeight}},watch:{markup:function(e){this.updateContent()},styles:function(e){this.updateContent()},index:function(e){this.updateFrameIfEmpty()}}};if(typeof a==="function"){a=a.options}Object.assign(a,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("div",{staticClass:"kBuilderPreview"},[_c("iframe",{ref:"previewFrame",staticClass:"kBuilderPreview__frame",style:{height:_vm.previewHeight+"px"},on:{"sizechange":_vm.onResize}}),_vm._v(" "),_c("script",{ref:"previewFrameContent",attrs:{"type":"text/template"}},[_vm._v("\n    <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n        <title>Kirby Builder Preview</title>\n        <style>\n          html,body{margin: 0;padding: 0;}\n          "+_vm._s(_vm.styles)+"\n        </style>\n      </head>\n      <body>\n        <div id=\"content\">\n          "+_vm._s(_vm.markup)+"\n        </div>\n      </body>\n    </html>\n  ")])])};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:"data-v-fd7b8d",functional:undefined}}());var b={props:{endpoints:Object,block:Object,index:Number,columnsCount:Number,pageUid:String,pageId:String,encodedPageId:String,styles:String,script:String,parentPath:String},components:{BuilderPreview:a},mounted:function(){this.block.isNew?this.$nextTick(function(){this.pending=!1}):this.pending=!1,this.block.content._uid||(this.block.content._uid=this.block.content._key+"_"+new Date().valueOf()+"_"+this._uid),this.activeFieldSet||(this.activeFieldSet=this.fieldSets[0].key);var e=JSON.parse(localStorage.getItem(this.localUiStateKey));e?(this.expanded=e.expanded,this.showPreview=e.showPreview,this.activeFieldSet=e.activeFieldSet):this.storeLocalUiState(),this.block.preview&&this.showPreview?this.displayPreview(this.block.preview):this.displayFieldSet(this.activeFieldSet),this.block.isNew&&this.$emit("input")},data:function(){return{pending:!0,activeFieldSet:null,expanded:!0,previewFrameContent:null,previewHeight:0,previewStored:!1,previewMarkup:"",showPreview:!1}},computed:{localUiStateKey:function(){return"kBuilder.uiState.".concat(this.block.content._uid)},extendedUid:function(){return this.pageId.replace("/","-")+"-"+this._uid},previewUrl:function(){return this.previewStored?"kirby-builder-preview/"+this.extendedUid+"?"+this.objectToGetParams(this.block.preview)+"&pageid="+this.pageId:null},blockPath:function(){return this.parentPath+"+"+this.block.blockKey},fieldSets:function(){var e=[];if(this.block.tabs){for(var t in this.block.tabs)if(this.block.tabs.hasOwnProperty(t)){var i=this.block.tabs[t];e.push(this.newFieldSet(i,t,this.block.content))}}else this.block.fields&&e.push(this.newFieldSet(this.block,"content",this.block.content,"edit",this.$t("edit")));return e}},methods:{onBlockInput:function(e){this.$emit("input",this.val)},displayPreview:function(){var e=this;this.showPreview=!0,this.expanded=!0;var t={preview:this.block.preview,blockContent:this.block.content,blockUid:this.extendedUid,pageid:this.pageId};this.$api.post("kirby-builder/rendered-preview",t).then(function(t){e.previewMarkup=t.preview,e.activeFieldSet=null}),this.storeLocalUiState()},displayFieldSet:function(e){this.showPreview=!1,this.activeFieldSet=e,this.previewHeight=0,this.storeLocalUiState()},onPreviewLoaded:function(e){this.previewHeight=e.detail.height,this.activeFieldSet=null},toggleExpand:function(e){this.expanded="boolean"==typeof e?e:!this.expanded,this.storeLocalUiState()},newFieldSet:function(e,t,i,n,o){var s=this;Object.keys(e.fields).forEach(function(t){e.fields[t].endpoints={field:"kirby-builder/pages/".concat(s.encodedPageId,"/fields/").concat(s.blockPath,"+").concat(e.fields[t].name)},e.fields[t].parentPath=s.blockPath});var r={fields:e.fields,key:t,model:i,icon:n||e.icon||null,label:o||e.label||null};return r},objectToGetParams:function(e){return Object.keys(e).map(function(t){return t+"="+e[t]}).join("&")},storeLocalUiState:function(){var e={expanded:this.expanded,showPreview:this.showPreview,activeFieldSet:this.activeFieldSet};localStorage.setItem(this.localUiStateKey,JSON.stringify(e))},tabIcon:function(e){return e?e.indexOf("/")>-1&&e.indexOf(".")>-1?null:e:null},tabImage:function(e){return e&&e.indexOf("/")>-1&&e.indexOf(".")>-1?e:null}}};if(typeof b==="function"){b=b.options}Object.assign(b,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("div",{class:["kBuilderBlock","kBuilderBlock--col-"+_vm.columnsCount,{"kBuilderBlock--pending":_vm.pending},{"kBuilderBlock--previewMode":_vm.showPreview&&_vm.expanded},{"kBuilderBlock--expanded":_vm.expanded},{"kBuilderBlock--collapsed":!_vm.expanded},{"kBuilderBlock--editMode":!_vm.showPreview&&_vm.expanded}]},[_c("div",{class:"kBuilderBlock__header kBuilderBlock__header--col-"+_vm.columnsCount},[_c("k-icon",{class:"kBuilder__dragDropHandle kBuilder__dragDropHandle--col-"+_vm.columnsCount,attrs:{"type":"sort"}}),_vm._v(" "),_c("span",{staticClass:"kBuilderBlock__label",on:{"click":_vm.toggleExpand}},[_c("k-icon",{staticClass:"kBuilderBlock__expandedIcon",class:{"kBuilderBlock__expandedIcon--expanded":_vm.expanded},attrs:{"type":"angle-down"}}),_vm._v(" "+_vm._s(_vm.block.label)+" ")],1),_vm._v(" "),_c("div",{staticClass:"kBuilderBlock__actions"},[_c("k-button-group",{staticClass:"kBuilderBlock__actionsGroup"},[_vm._l(_vm.fieldSets,function(fieldSet){return _vm.fieldSets.length>1||_vm.block.preview?_c("k-button",{key:"showFierldSetButton-"+_vm._uid+fieldSet.key,staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":_vm.activeFieldSet==fieldSet.key&&_vm.expanded},attrs:{"icon":_vm.tabIcon(fieldSet.icon),"image":_vm.tabImage(fieldSet.icon)},on:{"click":function($event){_vm.displayFieldSet(fieldSet.key);_vm.toggleExpand(true)}}},[_vm._v(_vm._s(fieldSet.label))]):_vm._e()}),_vm._v(" "),_vm.block.preview?_c("k-button",{staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":_vm.showPreview&&_vm.expanded},attrs:{"icon":"preview"},on:{"click":function($event){_vm.displayPreview()}}},[_vm._v(_vm._s(_vm.$t("builder.preview")))]):_vm._e()],2),_vm._v(" "),_c("div",{staticClass:"kBuilderBlock__control"},[_c("k-dropdown",{staticClass:"kBuilderBlock__actionsDropDown"},[_c("k-button",{staticClass:"kBuilderBlock__actionsButton",attrs:{"icon":"dots"},on:{"click":function($event){_vm.$refs["blockActions"+_vm.block.uniqueKey].toggle()}}}),_vm._v(" "),_c("k-dropdown-content",{ref:"blockActions"+_vm.block.uniqueKey},[_c("k-dropdown-item",{attrs:{"icon":"copy"},on:{"click":function($event){_vm.$emit("clone",_vm.index)}}},[_vm._v(_vm._s(_vm.$t("builder.clone")))]),_vm._v(" "),_c("k-dropdown-item",{attrs:{"icon":"trash"},on:{"click":function($event){_vm.$emit("delete",_vm.index)}}},[_vm._v(_vm._s(_vm.$t("delete")))])],1)],1)],1)],1)],1),_vm._v(" "),_c("div",{directives:[{name:"show",rawName:"v-show",value:_vm.expanded,expression:"expanded"}],staticClass:"kBuilderBlock__content"},[_vm.block.preview?_c("builder-preview",{directives:[{name:"show",rawName:"v-show",value:_vm.showPreview,expression:"showPreview"}],attrs:{"markup":_vm.previewMarkup,"styles":_vm.styles,"index":_vm.index,"script":_vm.script}}):_vm._e(),_vm._v(" "),_vm._l(_vm.fieldSets,function(fieldSet){return _vm.activeFieldSet===fieldSet.key?_c("k-fieldset",_vm._g({key:fieldSet.key+_vm._uid,staticClass:"kBuilderBlock__form",attrs:{"value":{},"fields":fieldSet.fields,"validate":true},model:{value:fieldSet.model,callback:function($$v){_vm.$set(fieldSet,"model",$$v)},expression:"fieldSet.model"}},_vm.$listeners)):_vm._e()})],2)])};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:null,functional:undefined}}());var c={props:{counter:[Boolean,Object],disabled:Boolean,endpoints:Object,help:String,input:[String,Number],name:[String,Number],required:Boolean,type:String,value:String,fieldsets:Object,columns:Number,max:Number,label:String,preview:Object,pageId:String,pageUid:String,encodedPageId:String,cssUrls:String,jsUrls:String,parentPath:String},components:{BuilderBlock:b},mounted:function(){for(var t=this,e=Object.entries(this.cssUrls),n=function(){var n=f(e[o],2),i=n[0],r=n[1];fetch(r.replace(/^\/+/g,"")).then(function(t){return t.text()}).then(function(e){t.$set(t.cssContents,i,e)})},o=0;o<e.length;o++)n();for(var i=Object.entries(this.jsUrls),r=function(){var e=f(i[s],2),n=e[0],o=e[1];fetch(o.replace(/^\/+/g,"")).then(function(t){return t.text()}).then(function(e){t.$set(t.jsContents,n,e)})},s=0;s<i.length;s++)r();this.value&&(this.value.forEach(function(e,n){var o=t.fieldsets[e._key];t.blocks.push(t.newBlock(o,e._key,e,n))}),this.lastUniqueKey=this.value.length)},data:function(){return{blocks:[],toggle:!0,targetPosition:null,lastUniqueKey:0,cssContents:{},jsContents:{},dialogOpen:!1}},computed:{val:function(){return this.blocks.map(function(t){return t.content})},path:function(){return this.parentPath?"".concat(this.parentPath,"+").concat(this.name):this.name},columnsCount:function(){return this.columns?this.columns:"1"},columnWidth:function(){return this.columns?"1/"+this.columns:"1/1"},draggableOptions:function(){return{group:"kirby-builder",clone:!0,handle:".kBuilder__dragDropHandle",forceFallback:!0,fallbackClass:"sortable-fallback",fallbackOnBody:!0,scroll:document.querySelector(".k-panel-view")}},blockCount:function(){return this.blocks.length},fieldsetCount:function(){return Object.keys(this.fieldsets).length},fieldsetKeys:function(){return Object.keys(this.fieldsets)},addBlockButtonLabel:function(){return this.$t("add")},supportedBlockTypes:function(){return Object.keys(this.fieldsets)}},methods:{onBlockInput:function(t){this.$emit("input",this.val)},onBlockMoved:function(t){this.$emit("input",this.val)},onBlockAdded:function(t){this.$emit("input",this.val)},onBlockRemoved:function(t){this.$emit("input",this.val)},onDragEnd:function(t){this.drag=!1},onMove:function(t){this.$root.$emit("blockMoved");var e=t.relatedContext.index!=this.blocks.length+1,n=t.draggedContext.futureIndex==t.draggedContext.index,o=0==this.blocks.length,i=this.supportedBlockTypes.includes(t.relatedContext.element.blockKey);return(o||e||n)&&i},onStartDrag:function(t){var e=t.item.getElementsByClassName("kBuilderPreview__frame")[0];e&&window.requestAnimationFrame(function(){var t=e.contentWindow.document,n=document.getElementsByClassName("sortable-drag")[0].getElementsByClassName("kBuilderPreview__frame")[0].contentWindow.document;n.open(),n.write(t.documentElement.innerHTML),n.close()})},onClickAddBlock:function(t){this.targetPosition=t,1==this.fieldsetCount?this.addBlock(this.fieldsetKeys[0]):this.$refs.dialog.open()},onOpenDialog:function(){this.dialogOpen=!0},onCloseDialog:function(){this.dialogOpen=!1},addBlock:function(t){var e=null==this.targetPosition?this.blocks.length:this.targetPosition,n=this.fieldsets[t],o=this.newBlock(n,t,this.getBlankContent(t,n),this.lastUniqueKey++);o.isNew=!0,this.blocks.splice(e,0,JSON.parse(JSON.stringify(o))),this.targetPosition=null,this.$emit("input",this.val),this.dialogOpen&&this.$refs.dialog.close()},getBlankContent:function(t,e){var n={_key:t};if(e.fields)Object.keys(e.fields).forEach(function(t){n[t]=e.fields[t].value||e.fields[t].default||""});else if(e.tabs)for(var o in e.tabs)e.tabs.hasOwnProperty(o)&&function(){var t=e.tabs[o];Object.keys(t.fields).forEach(function(e){n[e]=t.fields[e].value||t.fields[e].default||""})}();return n},cloneBlock:function(t){var e=JSON.parse(JSON.stringify(this.blocks[t]));e.isNew=!0,this.deepRemoveProperty(e.content,"_uid"),this.blocks.splice(t+1,0,e),this.blocks[t+1].uniqueKey=this.lastUniqueKey++,this.$emit("input",this.val)},deleteBlock:function(t){this.clearLocalUiStates(this.blocks[t]),this.blocks.splice(t,1),this.$emit("input",this.val)},deepRemoveProperty:function(t,e){var n=this;Object.keys(t).forEach(function(o){o===e?delete t[o]:"object"===d(t[o])&&n.deepRemoveProperty(t[o],e)})},clearLocalUiStates:function(t){for(var e in t)if(t.hasOwnProperty(e)){t[e];"_uid"===e?localStorage.removeItem("kBuilder.uiState.".concat(t[e])):"object"===d(t[e])&&this.clearLocalUiStates(t[e])}},newBlock:function(t,e,n,o){return{fields:t.fields?t.fields:null,tabs:t.tabs?t.tabs:null,blockKey:e,content:n,label:t.label,uniqueKey:o,preview:t.preview,showPreview:!1}}}};if(typeof c==="function"){c=c.options}Object.assign(c,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("k-field",{staticClass:"kBuilder",class:"kBuilder--col-"+_vm.columnsCount,attrs:{"label":_vm.label}},[_c("k-draggable",{staticClass:"kBuilder__blocks k-grid",attrs:{"list":_vm.blocks,"end":_vm.onDragEnd,"move":_vm.onMove,"options":_vm.draggableOptions},on:{"update":_vm.onBlockMoved,"add":_vm.onBlockAdded,"remove":_vm.onBlockRemoved},nativeOn:{"start":function($event){return _vm.onStartDrag($event)}}},[_vm._l(_vm.blocks,function(block,index){return _c("k-column",{key:block.uniqueKey,staticClass:"kBuilder__column",attrs:{"width":_vm.columnWidth}},[_c("div",{staticClass:"kBuilder__inlineAddButton",class:{"kBuilder__inlineAddButton--horizontal":_vm.columnsCount==1,"kBuilder__inlineAddButton--vertical":_vm.columnsCount>1},on:{"click":function($event){_vm.onClickAddBlock(index)}}}),_vm._v(" "),_c("builder-block",{attrs:{"page-id":_vm.pageId,"page-uid":_vm.pageUid,"encoded-page-id":_vm.encodedPageId,"block":block,"index":index,"columns-count":_vm.columnsCount,"show-preview":block.showPreview,"styles":_vm.cssContents[block.blockKey],"script":_vm.jsContents[block.blockKey],"parentPath":_vm.path},on:{"update:showPreview":function($event){_vm.$set(block,"showPreview",$event)},"input":_vm.onBlockInput,"clone":_vm.cloneBlock,"delete":_vm.deleteBlock}}),_vm._v(" "),_vm.columnsCount%index==0&&_vm.columnsCount>1?_c("div",{staticClass:"kBuilder__inlineAddButton kBuilder__inlineAddButton--vertical kBuilder__inlineAddButton--after",on:{"click":function($event){_vm.onClickAddBlock(index+1)}}}):_vm._e()],1)}),_vm._v(" "),!_vm.max||_vm.blockCount<_vm.max?_c("k-column",{attrs:{"width":_vm.columnWidth}},[_c("k-button",{staticClass:"kBuilder__addButton",attrs:{"icon":"add"},on:{"click":function($event){_vm.onClickAddBlock()}}},[_vm._v(" "+_vm._s(_vm.addBlockButtonLabel)+" ")])],1):_vm._e()],2),_vm._v(" "),_c("k-dialog",{ref:"dialog",staticClass:"kBuilder__dialog",on:{"open":_vm.onOpenDialog,"close":_vm.onCloseDialog}},[_c("k-list",_vm._l(_vm.fieldsets,function(value,key){return _c("k-list-item",{key:key,staticClass:"kBuilder__addBlockButton",attrs:{"text":value.label},on:{"click":function($event){_vm.addBlock(key)}}})}),1)],1)],1)};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:null,functional:undefined}}());panel.plugin("timoetting/k-builder",{fields:{builder:c}});})();